import unittest
import json
from app import app, db
from models import Task, Comment

class TaskCommentAPITestCase(unittest.TestCase):
    """Test suite for Task and Comment CRUD APIs"""

    def setUp(self):
        """Set up test client and database"""
        app.config['TESTING'] = True
        app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///:memory:'
        self.app = app
        self.client = app.test_client()
        
        with app.app_context():
            db.create_all()

    def tearDown(self):
        """Clean up database"""
        with app.app_context():
            db.session.remove()
            db.drop_all()

    # ==================== TASK TESTS ====================

    def test_create_task(self):
        """Test creating a new task"""
        response = self.client.post('/api/tasks',
            data=json.dumps({'title': 'Test Task', 'description': 'Test Description'}),
            content_type='application/json')
        
        self.assertEqual(response.status_code, 201)
        data = json.loads(response.data)
        self.assertEqual(data['title'], 'Test Task')
        self.assertEqual(data['description'], 'Test Description')

    def test_create_task_missing_title(self):
        """Test creating task without title should fail"""
        response = self.client.post('/api/tasks',
            data=json.dumps({'description': 'No title'}),
            content_type='application/json')
        
        self.assertEqual(response.status_code, 400)

    def test_get_all_tasks(self):
        """Test retrieving all tasks"""
        # Create test tasks
        with app.app_context():
            task1 = Task(title='Task 1', description='Desc 1')
            task2 = Task(title='Task 2', description='Desc 2')
            db.session.add(task1)
            db.session.add(task2)
            db.session.commit()

        response = self.client.get('/api/tasks')
        self.assertEqual(response.status_code, 200)
        data = json.loads(response.data)
        self.assertEqual(len(data), 2)
        self.assertEqual(data[0]['title'], 'Task 1')
        self.assertEqual(data[1]['title'], 'Task 2')

    def test_get_task_by_id(self):
        """Test retrieving a specific task"""
        with app.app_context():
            task = Task(title='Test Task', description='Test Desc')
            db.session.add(task)
            db.session.commit()
            task_id = task.id

        response = self.client.get(f'/api/tasks/{task_id}')
        self.assertEqual(response.status_code, 200)
        data = json.loads(response.data)
        self.assertEqual(data['title'], 'Test Task')

    def test_get_nonexistent_task(self):
        """Test retrieving non-existent task returns 404"""
        response = self.client.get('/api/tasks/999')
        self.assertEqual(response.status_code, 404)

    def test_update_task(self):
        """Test updating a task"""
        with app.app_context():
            task = Task(title='Original', description='Original Desc')
            db.session.add(task)
            db.session.commit()
            task_id = task.id

        response = self.client.put(f'/api/tasks/{task_id}',
            data=json.dumps({'title': 'Updated', 'description': 'Updated Desc'}),
            content_type='application/json')
        
        self.assertEqual(response.status_code, 200)
        data = json.loads(response.data)
        self.assertEqual(data['title'], 'Updated')
        self.assertEqual(data['description'], 'Updated Desc')

    def test_delete_task(self):
        """Test deleting a task"""
        with app.app_context():
            task = Task(title='Task to Delete', description='Delete me')
            db.session.add(task)
            db.session.commit()
            task_id = task.id

        response = self.client.delete(f'/api/tasks/{task_id}')
        self.assertEqual(response.status_code, 204)

        # Verify task is deleted
        response = self.client.get(f'/api/tasks/{task_id}')
        self.assertEqual(response.status_code, 404)

    def test_delete_task_cascades_comments(self):
        """Test deleting task also deletes its comments"""
        with app.app_context():
            task = Task(title='Task', description='Desc')
            comment = Comment(text='Comment text', task=task)
            db.session.add(task)
            db.session.add(comment)
            db.session.commit()
            task_id = task.id
            comment_id = comment.id

        # Delete task
        response = self.client.delete(f'/api/tasks/{task_id}')
        self.assertEqual(response.status_code, 204)

        # Verify comment is also deleted
        response = self.client.get(f'/api/comments/{comment_id}')
        self.assertEqual(response.status_code, 404)

    # ==================== COMMENT TESTS ====================

    def test_create_comment(self):
        """Test creating a comment for a task"""
        with app.app_context():
            task = Task(title='Task', description='Desc')
            db.session.add(task)
            db.session.commit()
            task_id = task.id

        response = self.client.post(f'/api/tasks/{task_id}/comments',
            data=json.dumps({'text': 'Test Comment'}),
            content_type='application/json')
        
        self.assertEqual(response.status_code, 201)
        data = json.loads(response.data)
        self.assertEqual(data['text'], 'Test Comment')
        self.assertEqual(data['task_id'], task_id)

    def test_create_comment_missing_text(self):
        """Test creating comment without text should fail"""
        with app.app_context():
            task = Task(title='Task', description='Desc')
            db.session.add(task)
            db.session.commit()
            task_id = task.id

        response = self.client.post(f'/api/tasks/{task_id}/comments',
            data=json.dumps({'text': ''}),
            content_type='application/json')
        
        self.assertEqual(response.status_code, 400)

    def test_get_comments_for_task(self):
        """Test retrieving all comments for a task"""
        with app.app_context():
            task = Task(title='Task', description='Desc')
            comment1 = Comment(text='Comment 1', task=task)
            comment2 = Comment(text='Comment 2', task=task)
            db.session.add(task)
            db.session.add(comment1)
            db.session.add(comment2)
            db.session.commit()
            task_id = task.id

        response = self.client.get(f'/api/tasks/{task_id}/comments')
        self.assertEqual(response.status_code, 200)
        data = json.loads(response.data)
        self.assertEqual(len(data), 2)
        self.assertEqual(data[0]['text'], 'Comment 1')
        self.assertEqual(data[1]['text'], 'Comment 2')

    def test_get_comment_by_id(self):
        """Test retrieving a specific comment"""
        with app.app_context():
            task = Task(title='Task', description='Desc')
            comment = Comment(text='Test Comment', task=task)
            db.session.add(task)
            db.session.add(comment)
            db.session.commit()
            comment_id = comment.id

        response = self.client.get(f'/api/comments/{comment_id}')
        self.assertEqual(response.status_code, 200)
        data = json.loads(response.data)
        self.assertEqual(data['text'], 'Test Comment')

    def test_update_comment(self):
        """Test updating a comment"""
        with app.app_context():
            task = Task(title='Task', description='Desc')
            comment = Comment(text='Original', task=task)
            db.session.add(task)
            db.session.add(comment)
            db.session.commit()
            comment_id = comment.id

        response = self.client.put(f'/api/comments/{comment_id}',
            data=json.dumps({'text': 'Updated Comment'}),
            content_type='application/json')
        
        self.assertEqual(response.status_code, 200)
        data = json.loads(response.data)
        self.assertEqual(data['text'], 'Updated Comment')

    def test_update_comment_missing_text(self):
        """Test updating comment without text should fail"""
        with app.app_context():
            task = Task(title='Task', description='Desc')
            comment = Comment(text='Original', task=task)
            db.session.add(task)
            db.session.add(comment)
            db.session.commit()
            comment_id = comment.id

        response = self.client.put(f'/api/comments/{comment_id}',
            data=json.dumps({'text': ''}),
            content_type='application/json')
        
        self.assertEqual(response.status_code, 400)

    def test_delete_comment(self):
        """Test deleting a comment"""
        with app.app_context():
            task = Task(title='Task', description='Desc')
            comment = Comment(text='Comment to Delete', task=task)
            db.session.add(task)
            db.session.add(comment)
            db.session.commit()
            comment_id = comment.id

        response = self.client.delete(f'/api/comments/{comment_id}')
        self.assertEqual(response.status_code, 204)

        # Verify comment is deleted
        response = self.client.get(f'/api/comments/{comment_id}')
        self.assertEqual(response.status_code, 404)

    def test_get_task_includes_comments(self):
        """Test that getting a task includes its comments"""
        with app.app_context():
            task = Task(title='Task', description='Desc')
            comment1 = Comment(text='Comment 1', task=task)
            comment2 = Comment(text='Comment 2', task=task)
            db.session.add(task)
            db.session.add(comment1)
            db.session.add(comment2)
            db.session.commit()
            task_id = task.id

        response = self.client.get(f'/api/tasks/{task_id}')
        self.assertEqual(response.status_code, 200)
        data = json.loads(response.data)
        self.assertEqual(len(data['comments']), 2)
        self.assertEqual(data['comments'][0]['text'], 'Comment 1')
        self.assertEqual(data['comments'][1]['text'], 'Comment 2')

if __name__ == '__main__':
    unittest.main()
